# CI

# After installation, you may want to expose the dashboard:
   $ kubectl expose svc tekton-dashboard -n default --type=NodePort --name=tekton-dashboard-np --port=9097 --target-port=9097 -n tekton-pipelines

# 1. PAT Personal Access Token on github
# 2. Create generic secret using PAT and your username:

   $ kubectl create secret generic git-credentials \
   --type=kubernetes.io/basic-auth \
   --from-literal=username="{username}" \
   --from-literal=password="${PAT}" \
   -n tekton-pipelines

# OR Create an ssh keypair
# Upload the public-key to your git settings
# Create a k8s secret through:

   $ kubectl create secret generic tekton-ssh-key  \
   --from-file=ssh-privatekey=${KEYPATH} \
   --type=kubernetes.io/ssh-auth \
   -n tekton-pipelines

   $ kubectl annotate secret tekton-ssh-key \
   tekton.dev/git-0=github.com \
   -n tekton-pipelines

# Make sure that the secret is ANNOTATED immediately and the SA uses the appropriate creds accordingly

   $ kubectl patch sa tekton-sa -n tekton-pipelines -p '{"secrets": [{"name": "tekton-ssh-key"}]}'


# CD

# During CD there may be times you will be required to add credentials for various registries, typical for tekton is the same as above.
# For this implementation do the following:

# 1. Create a Docker-Hub Account if dont already have one.
# 2. Create a generic secret using the credentials from step 1.
# 3. Patch the SA to use the new credentials.
    
    $ kubectl create secret docker-registry regcred \
    --docker-server=docker.io \
    --docker-username=<YOUR_DOCKERHUB_USERNAME> \
    --docker-password=<YOUR_DOCKERHUB_PASSWORD> \
    --docker-email=<YOUR_DOCKERHUB_EMAIL> \
    -n tekton-pipelines


    $ kubectl patch serviceaccount default -n tekton-pipelines -p '{"imagePullSecrets": [{"name": "regcred"}]}'

# The current CRD at 0.32.0 is supposed to control the svc of the eventListener, we would typically be able to define serviceType on the eventListener.yaml just bove triggers. However this is not currently merged, so a workaround to get a webhook setup for the eventListener is to expose the existing svc and create and externally accessible svc.

    $ kubectl expose svc event-listener -n default --type=NodePort --name=event-listener-external -n tekton-pipelines

# At the moment the PipelineRun generated by the trigger uses the default serviceAccount with no way to change it on the trigger-template. So
# temporarily allow the default SA of this namespace to use the same ssh-secrets as the tekton-sa.

    $ kubectl patch sa default -n tekton-pipelines -p '{"secrets": [{"name": "tekton-ssh-key"}]}'

# Also with automated pipelines, make sure to give the default SA access to the kubernetes namespace where the pipelineRun will deploy services to.
# Adjust the roleBinding to include the default SA

    $ vi ./permissions/tekton-devops-hq-eh-rbac.yaml

